<html>

<head>
<meta charset="utf-8">
<link rel="stylesheet"
	href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css">
<link
	href="https://unpkg.com/material-components-web@latest/dist/material-components-web.min.css"
	rel="stylesheet">
<script
	src="https://unpkg.com/material-components-web@latest/dist/material-components-web.min.js"></script>
<link rel="stylesheet"
	href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
<link rel="stylesheet"
	href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-treeview/1.2.0/bootstrap-treeview.min.css">
<title>Exercise Specification</title>

<style>
body {
	padding: 20px;
}

.dropdown-item:active {
	background-color: white;
	color: grey;
}

.dropdown-item:hover {
	background-color: grey;
	color: white;
}

.dropdown-menu {
	border: 1px solid lightgrey;
}

.card-body {
	background-color: lightgrey;
}

.container {
	width: 100%;
	min-width: 100%;
	padding: 0px;
}

h4 {
	font-size: 12pt;
	font-weight: bold;
}

.fa-angle-down {
	cursor: pointer;
}

.list-group-item {
	cursor: default;
	padding: 0px;
}

.list-group {
	min-height: 30px;
	width: 200px;
}

.sortable-group {
	min-height: 30px;
	width: 200px;
	border: 1px solid gray;
}

.invisible {
	visibility: collapse;
	display: none;
}

.floating-button {
	position: fixed;
	width: 50px;
	height: 50px;
	bottom: 20px;
	left: 20px;
	background: blue;
	border-radius: 50px;
	text-align: center;
	color: white;
	font-size: 25px;
	padding-top: 10px;
	border: none;
	filter: drop-shadow(2px 2px 10px blue) drop-shadow(-2px -2px 10px blue);
}

.floating-button:hover {
	text-decoration: none;
	background-color: white;
}

.close-button {
	float: right;
	color: white;
}

.bold-border {
	color: red;
	filter: drop-shadow(1px 1px 1px red) drop-shadow(-1px -1px 1px red)
		drop-shadow(-1px 1px 1px red) drop-shadow(1px -1px 1px red);
}

mark {
	border-radius: 10%;
	background-color: #99ccff;
	margin: 0px;
	padding: 0px;
}

.sortable {
	list-style-type: none;
	margin: 0;
	padding: 0;
	width: 100%;
}

.sortable li {
	margin: 0 3px 3px 0px;
	height: 18px;
}

.sortable li span {
	position: absolute;
}

.sortable li {
	cursor: move !important;
}
</style>
</head>

<body>
	<div class="container-fluid">
		<div class="row flex-nowrap">
			<div id="sidebar"
				class="col-auto col-md-3 col-xl-2 px-sm-2 px-0 bg-dark">
				<a class="close-button" onclick="hideSidebar();" href="#"><i
					class="fa fa-angle-left"></i></a>
				<div
					class="d-flex flex-column align-items-center align-items-sm-start px-3 pt-2 text-white min-vh-100"
					style="min-height: 100vh;">				
					<div data-toggle="collapse" data-target="#exercise-list" aria-expanded="true" aria-controls="exercise-list"
						class="d-flex align-items-center pb-3 mb-md-0 me-md-auto text-white text-decoration-none">
						<i class="fs-4 fa fa-book"></i><span
							class="ms-1 d-none d-sm-inline" style="margin-left: 10px;">Exercises</span>
					</div>
					<ul id="exercise-list" 
					class="nav nav-pills flex-column  align-items-center align-items-sm-start"></ul>
					<ul
						class="nav nav-pills flex-column mb-sm-auto mb-0 align-items-center align-items-sm-start">
						<li class="nav-item" id="add-exercise" style="margin-top: 20px;">
							<a href="#" class="nav-link align-middle px-0"
							onclick="addExercise();"> <i class="fs-4 fa fa-plus-square-o"></i><span
								class="ms-1 d-none d-sm-inline" style="margin-left: 10px;">Add
									item</span>
						</a>
						</li>
						<li class="nav-item"><a href="#"
							class="nav-link align-middle px-0"
							onclick="editExerciseAssemblies();"> <i
								class="fs-4 fa fa-puzzle-piece"></i><span
								class="ms-1 d-none d-sm-inline" style="margin-left: 10px;">Exercise
									assemblies</span>
						</a></li>
						<li class="nav-item"><a href="#"
							class="nav-link align-middle px-0"
							onclick="displayTypeSettings();"> <i
								class="fs-4 fa fa-th-large"></i><span
								class="ms-1 d-none d-sm-inline" style="margin-left: 10px;">Exercise
									types</span>
						</a></li>
						<li class="nav-item"><a href="#"
							class="nav-link align-middle px-0" onclick="save();"> <i
								class="fs-4 fa fa-floppy-o"></i><span
								class="ms-1 d-none d-sm-inline" style="margin-left: 10px;">Save
									to file</span>
						</a></li>
						<li class="nav-item"><input id="btn-upload" type="file"
							accept="text/json" class="invisible" onchange="upload(this);">
							<a href="#" class="nav-link align-middle px-0" onclick="load();">
								<i class="fs-4 fa fa-upload"></i><span
								class="ms-1 d-none d-sm-inline" style="margin-left: 10px;">Load
									from file</span>
						</a></li>
					</ul>
				</div>
			</div>
			<div class="col py-3">
				<div class="card" style="margin-bottom: 100px;">
					<div class="card-body" id="topicdrp">
						<span style="font-weight: bold; margin-right: 5px;">Topic:</span>
						<button id="btnTopic"
							class="btn btn-outline-secondary btn-sm dropdown-toggle"
							type="button" data-toggle="dropdown" aria-haspopup="true"
							aria-expanded="false">---</button>
						<div class="dropdown-menu" aria-labelledby="btnTopic">
							<a class="dropdown-item" href="#" onclick="updateDropdown(this);">Conditionals</a>
							<a class="dropdown-item" href="#" onclick="updateDropdown(this);">Relative pronouns</a>
						</div>
					</div>
					<div class="card-footer">
						<div class="content-area">
							<div id="content-area"></div>
							<div id="type-settings" class="container invisible">
								<p style="font-weight: bold;">Select the exercise types to
									generate for the exercise specifications.</p>
								<div class="treeview">
									<ul id="types-tree" class="list-group collapse-tree"
										style="width: 100%;">
									</ul>
								</div>
							</div>
							<div id="exercise-assemblies" class="invisible">
								<div id="assembly-container"></div>
								<a class="fa fa-plus" href="#" id="add-assembly-button"
									onclick="addExerciseAssembly(this);"> Add exercise</a>
							</div>
						</div>
					</div>
				</div>
				<a id="settings-button" class="fa fa-cog floating-button invisible"
					onclick="showSidebar();" href="#"></a>
			</div>
		</div>
	</div>
	<a id="downloadAnchorElem" style="display: none"></a>
	<script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"></script>
	
	<script src="https://code.jquery.com/jquery-3.6.0.js"></script>
	<script src="https://code.jquery.com/ui/1.13.1/jquery-ui.js"></script>
	<script
		src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js"></script>
	<script
		src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js"></script>
	<script
		src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-treeview/1.2.0/bootstrap-treeview.min.js"></script>
	<script type="text/javascript" id="mainScript">
	  
		function onExerciseItemCheckedWrapper(item) {
			onExerciseItemChecked($(item));
		}
		
		function onExerciseItemChecked(item) {
			if(item.is(':checked')) {
				if(item.closest(".container").find(".sortable").find("#i" + item.attr("id").substring(1)).length === 0) {
					let itemText = item.closest("div").prev().find(".item").text();
					if(itemText.trim().length > 0) {
						itemText += ": ";
					}
					item.closest(".container").find(".sortable").append('<li id="i' + item.attr("id").substring(1) + '" class="ui-state-default"><span class="ui-icon ui-icon-arrowthick-2-n-s"></span>' + itemText + item.next().text() + '</li>');
					$( ".sortable" ).sortable();	
				}
			} else {
				item.closest(".container").find(".sortable").find("#i" + item.attr("id").substring(1)).remove();
			}
		}
		
		function onTopItemChecked(item) {
			onTypeChecked(item);
			if ($(item).closest(".list-group-item").next().hasClass("collapse")) {
				$(item).closest(".list-group-item").next().find(".form-check-input").prop('checked', $(item).is(':checked')).each(function() {
					onExerciseItemChecked($(this));
				});
			}
		}
	
		function onItemChecked(item) {
			onItemCheckedWrapper($(item));
		}
		
		function onItemCheckedWrapper(item) {
			onExerciseItemChecked(item);
			onTypeCheckedWrapper(item);
		}
		
		var maxAssemblyId = 0;

		function addExerciseAssembly() {
			let classname;
			if ($("#btnTopic").text() === "Conditionals") {
				classname = "cond";
			} else if ($("#btnTopic").text() === "Relative pronouns") {
				classname = "rel";
			} else {
				return;
			}
			
			let count = $("#exercise-assemblies").find("h3").length;
			let exStr = '<div class="assembly ' + classname + '"><h3><input type="text" value="Exercise ' + ++count + 
					'"></h3><a class="fa fa-trash" style="float:right;color:red;" href="#" onclick="deleteAssembly(this);"></a><div class="container"><div class="row"><div class="col-sm"><div class="treeview-ex"><ul id="a' + 
					++maxAssemblyId + '" class="list-group assembly-tree ' + classname + ' collapse-tree" style="width: 100%;">';
			
			for (const exercise of $(".exercise-spec." + classname)) {
				let itemname = $(exercise).find("h3").text();
				let itemid = $(exercise).attr("id");
				
				if(classname === "cond") {
					exStr += getAssemblyCondElementString(itemid, itemname, maxAssemblyId);
				} else if(classname === "rel") {
					if($(exercise).find(".editable-chunks").length > 0) {
						let treeItem = getAssemblyItemElementString(itemid, itemname, maxAssemblyId);
						
						let i = 0;
						$(exercise).find(".editable-chunks").each(function () {
							treeItem += getAssemblyRCElementString($(this).closest(".rel-sentence-order").attr("id"), 
									++i, 
									$(this).text().replaceAll("|", " "),
									maxAssemblyId);
						});
						treeItem += "</div>";
						
						exStr += treeItem;
					}
				}
			}			
			
			exStr += '</ul></div></div><div class="col-sm">Item order:<div class="card"><div class="card-body" style="padding: 0px; padding-left: 25px;"><input type="checkbox" class="form-check-input" onclick="displayOrderSortable(this)"><label class="form-check-label">Randomize</label></div><div class="card-footer"><ul class="sortable"></ul></div></div></div><br></div></div>';
			$( ".sortable" ).sortable();
			$("#assembly-container").append(exStr);
		}
		
		function displayOrderSortable(item) {
			if($(item).is(':checked')) {
				$(item).closest(".card").find(".card-footer").addClass("invisible");
			} else {
				$(item).closest(".card").find(".card-footer").removeClass("invisible");
			}
		}
				
		function editExerciseAssemblies() {
			let classname;
			if ($("#btnTopic").text() === "Conditionals") {
				classname = "cond";
			} else if ($("#btnTopic").text() === "Relative pronouns") {
				classname = "rel";
			}
			
			if($(".exercise-spec." + classname).length > 0) {
				$("#add-assembly-button").removeClass("invisible");
			} else {
				$("#add-assembly-button").addClass("invisible");
			}
			
			$(".exercise-spec").addClass("invisible");
			$("#type-settings").addClass("invisible");
			
			$("#exercise-assemblies").removeClass("invisible");
			$(".assembly").addClass("invisible");
			$(".assembly." + classname).removeClass("invisible");
		}
	
		/** 
		 Marks the clicked list item as active.
		*/
		function addItem(el) {
			$(el).toggleClass('active');
		};

		/** 
		 Changes the text of the dropdown on selection changed.
		*/
		function updateDropdown(item) {
			$(item).parent().prev().text($(item).text());

			if ($("#topicdrp").get(0) === $(item).parent().parent().get(0)) {
				onSelectedTopicChanged();
			}
		}
		
		function onSelectedTopicChanged() {
			let displayType = true;
			if($("#type-settings").hasClass("invisible")) {
				displayType = false;
			}
			
			let classname;
			if ($("#btnTopic").text() === "Conditionals") {
				classname = "cond";
			} else if ($("#btnTopic").text() === "Relative pronouns") {
				classname = "rel";
			}
			
			if($(".exercise-spec." + classname).length > 0) {
				$("#add-assembly-button").removeClass("invisible");
			} else {
				$("#add-assembly-button").addClass("invisible");
			}
			
			$(".rel").addClass("invisible");
			$(".cond").addClass("invisible");
			
			$("." + classname).removeClass("invisible");
			$(".exercise-spec." + classname).addClass("invisible");

			if(displayType) {
				displayTypeSettings();
			}
		}

		
		
		function openModal(item, popupId) {
			$(popupId).find("input").val($(item).text());
		    $(popupId).modal('toggle');
		}
		
		/**
		 Adds the item specified in the popup to the associated list.
		*/
		function addDistractor(item) {
			maxPopupId++;
			let itemStr = '<li class="ui-state-default"><span class="ui-icon ui-icon-arrowthick-2-n-s"></span><span ondblclick="openModal(this, \'#p' + 
					maxPopupId + '\');">' + $(item).parent().prev().find(">:first-child").val() + '</span>' + 
					getPopupString("Edit distractor", "changeSortableText", "OK") + 
					'<a class="fa fa-times" style="float:right;color:red;" href="#" onclick="removeSortableItem(this);"></a></li>'
			$(item).closest(".sortable-group").find(".sortable").append(itemStr);
			$(item).parent().prev().find(">:first-child").val("");
		}
		
		var maxPopupId = 0;
		
		function getPopupString(popupTitle, callback, buttonText) {
			return '<div class="modal hide fade" id="p' + maxPopupId + '" tabindex="-1" role="dialog" aria-labelledby="p' + maxPopupId + 
					'Label" aria-hidden="true"><div class="modal-dialog" role="document"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="p' + 
					maxPopupId + 'Label">' + popupTitle + 
					'</h5><button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button></div><div class="modal-body"><input type="text"></div><div class="modal-footer"><button type="button" class="btn btn-primary" onclick="' + 
					callback + '(this);" data-dismiss="modal">' + buttonText + '</button></div></div></div></div></div>'
		}
		
		function changeSortableText(item) {
			$(item).closest(".modal").prev().text($(item).closest(".modal").find("input").val());
		}

		/**
		 Toggles the view between edit and view mode for the chunks.
		*/
		function displayEditChunks(item) {
			if ($(item).prev().hasClass("invisible")) {
				$(item).prev().removeClass("invisible");
				$(item).prev().prev().addClass("invisible");
				$(item).addClass("fa-eye");
				$(item).removeClass("fa-pencil");
			} else {
				$(item).prev().addClass("invisible");
				$(item).prev().prev().removeClass("invisible");
				$(item).removeClass("fa-eye");
				$(item).addClass("fa-pencil");
			}
		}

		/**
		 Reacts to changes in the chunks edit view.
		*/
		function changeChunks(item) {
			updateChunks($(item));
		}
		
		function changeRelativeChunks(item) {
			$(item).parent().prev().empty();
			let chunks = $(item).text().split("|");
			chunks.forEach(chunk => $(item).parent().prev().append("<span style='border:1px solid grey; margin-right: 2px;'>" + chunk.trim() + "</span>"));
		
			if($(item).val().trim().length > 0) {				
				let itemid = $(item).closest(".exercise-spec.rel").attr("id");
				let itemname = $(item).closest(".exercise-spec.rel").find("h3").text();
				let assemblyListItem = $(".itemid" + $(item).closest(".rel-sentence-order").attr("id"));
				if(assemblyListItem.length > 0) {
					// overwrite the previous text in existing entries in the trees
					assemblyListItem.find("label").text('RC ' + (countPreviousSiblings(assemblyListItem, 0) + 1) + ' (' + $(item).val().replaceAll("|", " ") + ')');
				} else {
					let itemNode = $(".ti" +itemid);
					if(itemNode.length === 0) {
						// create a new item node
						$(".assembly-tree.rel").each(function() {
							let treeItem = getAssemblyItemElementString(itemid, itemname, $(this).attr("id"));
							$(this).append(treeItem);
						});
					}
															
					$(".assembly-tree.rel").each(function() {
						// create a new rc node
						let newitem = getAssemblyRCElementString($(item).closest(".rel-sentence-order").attr("id"),
								(countPreviousSiblings(assemblyListItem, 0) + 1),
								$(item).val().replace("|", " "),
								$(this).attr("id")) 
								+ "</div>";
						$(this).find(".e" + itemid).append(newitem);
					});
				}				
			} else {
				removeAssemblyItem($(item));
			}

			setInputValues($(item).closest(".chunks-container").find('.idx'));
		}
		
		function getAssemblyItemElementString(itemid, itemname, assemblyId) {
			return '<li class="list-group-item node-treeview-ex ti' + itemid + '" style="border:0px;background:none;"><span class="form-check"><input type="checkbox" class="form-check-input" onclick="onTopItemChecked(this)"><label class="form-check-label item" data-toggle="collapse" data-target="#e' + assemblyId + itemid + '" aria-expanded="true" aria-controls="e'+  assemblyId + itemid + '">' + itemname + '</label></span></li><div id="e' + assemblyId + itemid + '" class="collapse show e' + itemid + '">';
		}
		
		function getAssemblyRCElementString(itemid, rcCount, rcText, assemblyId) {
			return '<li class="list-group-item node-treeview-ex itemid' + itemid + '" style="border:0px;background:none;"><span class="form-check" style="margin-left: 10px;"><input id="l' + assemblyId + itemid + '" type="checkbox" class="form-check-input" onclick="onItemChecked(this)"><label class="form-check-label">RC ' + rcCount + ' (' + rcText + ')</label></span></li>';
		}
		
		function getAssemblyCondElementString(itemid, itemname, assemblyId) {
			return '<div id="e' + assemblyId + itemid + '" class="e' + itemid + '"><li class="list-group-item node-treeview-ex itemid' + itemid + '" style="border:0px;background:none;"><span class="form-check"><input id="l' + assemblyId + itemid + '" type="checkbox" class="form-check-input" onclick="onExerciseItemCheckedWrapper(this)"><label class="form-check-label">' + itemname + '</label></span></li></div>';
		}
		
		function countPreviousSiblings(item, count) {
			if(item.prev().length > 0) {
				return countPreviousSiblings(item.prev(), ++count);
			}
			return count;
		}

		/**
		 Updates the spinners and the title line when the chunks have been modified.
		*/
		function updateChunks(item) {
			item.parent().prev().empty();
			let chunkString = item.html();

			let pronounStart = item.html().indexOf("<mark>");
			if(pronounStart != - 1) {
				let pronounEnd = item.html().indexOf("</mark>");
				let newString = chunkString.substring(0, pronounStart).trim();
				if(!newString.endsWith("|")) {
					newString += "|";
				}
				newString += chunkString.substring(pronounStart, pronounEnd + 7).trim().replaceAll("|", " ");
				
				let newPart = chunkString.substring(pronounEnd + 7).trim();
				if(!newPart.startsWith("|")) {
					newPart = "|" + newPart;
				}
				chunkString = newString + newPart;
			}
			
			chunkString = chunkString.trim();
			
			if(chunkString.startsWith("|")) {
				chunkString = chunkString.substring(1)
			}
			if(chunkString.endsWith("|")) {
				chunkString = chunkString.substring(0, chunkString.length - 1);
			}
			chunkString = chunkString.trim();
			
			item.html(chunkString);
			 	
			let chunks = chunkString.split("|");
			chunks.forEach(chunk => {
				if(chunk.includes("<mark>") && !chunk.startsWith("<mark>")) {
					chunk += "</mark>";
				} else if(chunk.includes("</mark>") && !chunk.includes("<mark>")) {
					chunk = "<mark>" + chunk;
				}
				item.parent().prev().append("<span style='border:1px solid grey; margin-right: 2px;'>" + chunk.trim() + "</span>");
			});
			item.closest(".spec").find('.idx.gap').each(function () {
				setInputValues($(this));
			});
		}

		/**
		 Sets the spinner values and associated texts when the chunks are modified.
		 Sets them to 0 and empty values if the chunks have been removed entirely.
		 Sets them to 1 and the chunk if a chunk has been added and no chunk has been there before.
		*/
		function setInputValues(item) {
			if (item.val() == 0) {
				item.val(1);
			}

			changeSpinnerText(item);
		}

		/**
		 Sets title line of conditional sentences.
		 Context before + main clause + if-clause + context after.
		*/
		function changeTitleLine(sentence) {
			let mainSentence = sentence.find(".chunksViewMain").find(">:first-child").val().replaceAll("|", " ");
			let conditionalSentence = sentence.find(".chunksView").find(">:first-child").val().replaceAll("|", " ");
			if (conditionalSentence.length > 0) {
				conditionalSentence = " " + conditionalSentence;
			}

			let sent = "";
			if (mainSentence.length > 0 || conditionalSentence.length > 0) {
				let delimiter = (mainSentence.length > 0 && conditionalSentence.length > 0) ? " " : "";
				sent = mainSentence + delimiter + conditionalSentence + ". ";
			}

			sentence.prev().prev().find(".context").text(sentence.find(".contextBefore").val() + " " + sent + sentence.find(".contextAfter").val());
		}

		/**
		 Reacts to changes in the spinner value.
		*/
		function onSpinnerChanged(item) {
			changeSpinnerText($(item));
		}

		/**
		 Updates the chunk preview for the associated spinner.
		*/
		function changeSpinnerText(item) {
			let chunks = item.closest(".chunks-container").find(".editable-chunks").text().split("|");

			if (chunks.length === 1 && chunks[0] === "") {
				item.parent().find(".idx").attr("max", 0);
				item.parent().find(".idx").attr("min", 0);
				item.parent().find(".idx").val(0);
				item.parent().find(".spnLabel").text("");
			} else {
				for (const spn of item.parent().find(".idx")) {
					if ($(spn).val() > chunks.length) {
						$(spn).val(chunks.length);
					}
				}

				let spn1 = item.parent().find(".spn1");
				let lowerValue = 1;
				if(spn1.length > 0) {
					lowerValue = item.parent().find(".spn1").val();
				}
				let upperValue = item.parent().find(".spn2").val();
				
				item.parent().find(".idx").attr("max", chunks.length);
				item.parent().find(".idx").attr("min", 1);

				if (!(chunks.length === 1 && chunks[0] === "")) {
					let chunks_in_range = [];
					for (let i = lowerValue - 1; i < upperValue; i++) {
						chunks_in_range.push(chunks[i]);
					}
					
					item.parent().find(".spnLabel").text("(" + chunks_in_range.join(" ") + ")");
				}
			}
		}

		var maxRelSentenceId = 0;

		function addRelativeOrderChunks(item) {
			addRelativeOrder($(item).parent().prev());
		 }
		
		/** 
		 Adds controls to specify a possible relative clause for the sentence.
		*/
		function addRelativeOrder(orderItem) {
			 orderItem.append('<tr class="rel-sentence-order chunks-container" id="' + ++maxRelSentenceId + '"><td><div><span></span><span class="chunksView invisible"><span contenteditable="true" class="highlighting editable-chunks" style="border:1px solid grey; background-color: white; width:200px; display:inline-block;vertical-align:middle; padding:2px;" onKeyUp="changeRelativeChunks(this);"></span><button type="button" class="btn btn-outline-secondary btn-sm fa fa-i-cursor" style="margin-right: 20px;" onclick="markReferent(this);" data-dismiss="modal" ></button></span><a style="margin-left: 10px;" class="fa fa-pencil" onclick="displayEditChunks(this);" href="#"></a></div></td><td>1 - <input class="idx gap spn2" type="number" value="0" min="0" max="0" step="1" onchange="onSpinnerChanged(this);" style="width:50px;"><span class="spnLabel"></span></td><td style="text-align: center;"><input type="checkbox" class="pronOpt"></td><td><a class="fa fa-times" style="float:right;color:red;" href="#" onclick="deleteOrder(this);"></td></tr>');
		}
		
		/**
		 Marks the selected text in the corresponding text field in blue color.
		*/
		function markReferent(item) {
			if (typeof window.getSelection != "undefined" && window.getSelection().rangeCount === 1) {
				var container = document.createElement("div");
				var range = window.getSelection().getRangeAt(0);
				let textfield = $(item).closest("td").find(".highlighting");

				if (range.commonAncestorContainer !== textfield.get(0) && range.commonAncestorContainer.parentElement !== textfield.get(0)
						&& range.commonAncestorContainer.parentElement.parentElement !== textfield.get(0)) {
					return;
				}

				container.appendChild(range.cloneContents());
				let html = container.innerHTML;
				let start = range.startOffset;	// start within the container
	
				if (textfield.html().includes("</mark>") && textfield.html().endsWith($(range.startContainer).text())) {
					start += textfield.html().indexOf("</mark>") - 6;
				} else if(!textfield.html().startsWith($(range.startContainer).text())) {
					start += textfield.html().indexOf("<mark>");
				}
				
				html = html.replaceAll("<mark>", "").replaceAll("</mark>", "");

				let end = html.length + start;
				let newText = textfield.text().substring(0, start) + "<mark>" + textfield.text().substring(start, end) + "</mark>" + textfield.text().substring(end);
				textfield.html(newText);
				
				updateChunks(textfield);
			}
		}

		/**
		 Removes the corresponding relative clause from the sentence.
		*/
		function deleteOrder(item) {
			removeAssemblyItem($(item));
			$(item).closest(".rel-sentence-order").remove();
		}
		
		function removeAssemblyItem(item) {
			if($(".itemid" + item.closest(".rel-sentence-order").attr("id")).first().parent().find("li").length == 1) {
				$(".itemid" + item.closest(".rel-sentence-order").attr("id")).first().parent().prev().remove();
			}
			$(".itemid" + item.closest(".rel-sentence-order").attr("id")).prop("checked", false);
			$(".itemid" + item.closest(".rel-sentence-order").attr("id")).find(".editable-chunks").each(function () {
				onExerciseItemChecked($(this));
			});
			$(".itemid" + item.closest(".rel-sentence-order").attr("id")).remove();
		}

		var maxExerciseId = 0;

		/**
		 Adds an empty exercise item.
		 Adds it to the sidebar.
		 Sets the previously displayed exercise item to invisible.
		*/
		function addExercise() {
			let className;
			if ($("#btnTopic").text() === "Conditionals") {
				className = "cond";
			} else if ($("#btnTopic").text() === "Relative pronouns") {
				className = "rel";
			}

			let count = ++maxExerciseId;
			$(".exercise-spec").addClass("invisible");
			$("#type-settings").addClass("invisible");
			$("#exercise-assemblies").addClass("invisible");

			if ($("#btnTopic").text() === "Conditionals") {
				addConditionalExercise(count);
			} else if ($("#btnTopic").text() === "Relative pronouns") {
				addRelativeExercise(count);
			}

			if (className) {
				$("#exercise-list").append('<li id="nav-ex' + count + '" class="nav-item ' + className + '"><a href="#" class="nav-link align-middle px-0" onclick="displayExercise(\'#exercise-spec-' + className + count + '\');"><span class="ms-1 d-none d-sm-inline">Item</span> <span class="fs-4">' + count + '</span><span class="ms-1 d-none d-sm-inline custom-title"></span></a></li>');
			}
			
			if ($("#btnTopic").text() === "Conditionals") {
				let itemid = $(".exercise-spec").last().attr("id");
				let itemname = $(".exercise-spec").last().find("h3").text();											
				$(".assembly-tree.cond").each(function() {
					// create a new cond node
					let newitem = getAssemblyCondElementString(itemid,
							itemname,
							$(this).attr("id"));
					$(this).append(newitem);
				});
			}
		}

		/**
		 Adds controls to specify an additional conditional exercise.
		 Adds the link in the sidebar and displays the new exercise in the main part.
		*/
		function addConditionalExercise(count) {
			$("#content-area").append('<div class="exercise-spec cond" id="exercise-spec-cond' + count + '"><a class="fa fa-trash" style="float:right;color:red;" href="#" onclick="deleteExercise(this);"></a><h3>Item ' + 
					count + '</h3><div class="sentence-unit"><table><tr class="condType"><td>Conditional type:</td><td><button id="condTypeDrp' + count + '" class="btn btn-outline-secondary btn-sm dropdown-toggle btn-cond-type" type="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">---</button><div class="dropdown-menu" aria-labelledby="condTypeDrp' + 
					count + '"><a class="dropdown-item" href="#" onclick="updateDropdown(this);">Type 1</a><a class="dropdown-item" href="#" onclick="updateDropdown(this);">Type 2</a></div></td></tr><tr><td>Context before: </td><td><input type="text" class="contextBefore" value=""></td></tr><tr><td>Context after: </td><td><input type="text" class="contextAfter" value=""></td></tr><tr><td>Feedback: </td><td><input type="text" class="feedback" value=""></td></tr></table><br><div class="container"><div class="row"><div class="col-sm main-clause"><h4>Main clause:</h4><table class="spec chunks-container"><tr class="chunks"><td>Chunks:</td><td><div><span></span><span class="chunksViewMain invisible"><span contenteditable="true" class="highlighting" style="border:1px solid grey; background-color: white; width:200px; display:inline-block;vertical-align:middle; padding:2px;" class="editable-chunks" onKeyUp="changeChunks(this);"></span><button type="button" class="btn btn-outline-secondary btn-sm fa fa-i-cursor" style="margin-right: 20px;" onclick="markReferent(this);" data-dismiss="modal" ></span><a class="fa fa-pencil" onclick="displayEditChunks(this);" href="#"></a></div></td></tr><tr class="translation"><td>Translation:</td><td><input type="text"></td></tr>' + 
					getSortableItemsWidgetString("distractors", "Distractors:", "distractorPopupMain", "Add distractor", count) + 
					'<tr class="given-word"><td>Given word:</td><td><input type="text"></td></tr><tr class="semantic-distractor"><td>Semantic distractor:</td><td><input type="text"></td></tr>' + 
					getSortableItemsWidgetString("given-words-ext", "Given words extended:", "givenWordsPopupMain", "Add given word", count) + 
					'<tr class="gap"><td>Gap:</td><td><input class="idx gap spn1" type="number" value="0" min="0" max="0" step="1" onchange="onSpinnerChanged(this);" style="width:50px;"> - <input class="idx gap spn2" type="number" value="0" min="0" max="0" step="1" onchange="onSpinnerChanged(this);" style="width:50px;"><span class="spnLabel"></span></td></tr><tr class="mtw-target"><td>MtW target:</td><td><input class="idx mtw spn1" type="number" value="0" min="0" max="0" step="1" onchange="onSpinnerChanged(this);" style="width:50px;"> - <input class="idx mtw spn2" type="number" value="0" min="0" max="0" step="1" onchange="onSpinnerChanged(this);" style="width:50px;"><span class="spnLabel"></span></td></tr></table><br></div><div class="col-sm if-clause"><h4>If-clause:</h4><table class="spec chunks-container"><tr class="chunks"><td>Chunks:</td><td><div><span></span><span class="chunksView invisible"><span contenteditable="true" class="highlighting" style="border:1px solid grey; background-color: white; width:200px; display:inline-block;vertical-align:middle; padding:2px;" class="editable-chunks" onKeyUp="changeChunks(this);"></span><button type="button" class="btn btn-outline-secondary btn-sm fa fa-i-cursor" style="margin-right: 20px;" onclick="markReferent(this);" data-dismiss="modal" ></span><a class="fa fa-pencil" onclick="displayEditChunks(this);" href="#"></a></div></td></tr><tr class="translation"><td>Translation:</td><td><input type="text"></td></tr>' + 
					getSortableItemsWidgetString("distractors", "Distractors:", "distractorPopup", "Add distractor", count) + 
					'<tr class="given-word"><td>Given word:</td><td><input type="text"></td></tr><tr class="semantic-distractor"><td>Semantic distractor:</td><td><input type="text"></td></tr>' + 
					getSortableItemsWidgetString("given-words-ext", "Given words extended:", "givenWordsPopup", "Add given word", count) + 
					'<tr class="gap"><td>Gap:</td><td><input class="idx gap spn1" type="number" value="0" min="0" max="0" step="1" onchange="onSpinnerChanged(this);" style="width:50px;"> - <input class="idx gap spn2" type="number" value="0" min="0" max="0" step="1" onchange="onSpinnerChanged(this);" style="width:50px;"><span class="spnLabel"></span></td></tr><tr class="mtw-target"><td>MtW target:</td><td><input class="idx mtw spn1" type="number" value="0" min="0" max="0" step="1" onchange="onSpinnerChanged(this);" style="width:50px;"> - <input class="idx mtw spn2" type="number" value="0" min="0" max="0" step="1" onchange="onSpinnerChanged(this);" style="width:50px;"><span class="spnLabel"></span></td></tr></table></div></div></div><br></div></div>');
			  $( ".sortable" ).sortable();
		}

		/**
		 Adds controls to specify an additional relative exercise.
		 Adds the link in the sidebar and displays the new exercise in the main part.
		*/
		function addRelativeExercise(count) {
			$("#content-area").append('<div class="exercise-spec rel" id="exercise-spec-rel' + count + 
					'"><a class="fa fa-trash" style="float:right;color:red;" href="#" onclick="deleteExercise(this);"></a><h3>Item ' + 
					count + '</h3><div class="sentence-unit"><span class="context"></span></div><div id="sentence' + count + 
					'" class="sentence"><table><tr><td>Context before: </td><td><input type="text" class="contextBefore" value=""></td></tr><tr><td>Context after: </td><td><input type="text" class="contextAfter" value=""></td></tr></table><br><table class="spec"><tr class="clause c1"><td>Clause 1:</td><td><input type="text"></td></tr><tr class="clause c2"><td>Clause 2:</td><td><input type="text"></td></tr>' + 
					getSortableItemsWidgetString("pronouns", "Pronoun:", "pronounPopup", "Add pronoun", count) + 
					getSortableItemsWidgetString("distractors", "Distractors:", "distractorPopupMain", "Add distractor", count) + 
					'<tr><td>Feedback: </td><td><input type="text" class="feedback" value=""></td></tr></table><div style="font-weight:bold; margin-top:20px;">Relative clauses:</div><table class="orders"><tr><td style="width: 400px; margin-right: 10px;">Chunks:</td><td>Use as prompt:</td><td style="margin-right: 10px;">Pronoun is optional:</td><td></td></tr></table><div><a class="fa fa-plus" href="#" onclick="addRelativeOrderChunks(this);" style="margin-top: 20px;"> Add relative clause alternative</a></div></div></div>');
			  $( ".sortable" ).sortable();
		}
		
		function getSortableItemsWidgetString(classname, title, popupId, popupTitle, count) {
			maxPopupId++;
			return '<tr class="' + classname + '"><td>' + title + 
			'</td><td><table class="list-cont"><tr class="listItems"><td><div class="sortable-group"><ul class="sortable"></ul>' + 
			getPopupString(popupTitle, "addDistractor", "Add") + 
			'</div></td><td><a class="fa fa-plus" aria-hidden="true" href="#" data-toggle="modal" data-target="#p' + maxPopupId + 
			'"></a></td></tr></table></td></tr>';
		}
		
		function removeSortableItem(item) {
			$(item).parent().remove();
		}
		
		/**
		 Sets the clicked exercise to visible in the main panel.
		 Hides all other exercise items.
		*/
		function displayExercise(exerciseId) {
			$(".exercise-spec").addClass("invisible");
			$("#type-settings").addClass("invisible");
			$("#exercise-assemblies").addClass("invisible");
			$(exerciseId).removeClass("invisible");
		}

		/**
		 Removes the corresponding exercise from the main part and the sidebar.
		*/
		function deleteExercise(item) {
			deleteExerciseItem($(item).closest(".exercise-spec"));
		}

		/**
		 Removes the specified exercise from the main part and the sidebar.
		*/
		function deleteExerciseItem(exercise) {
			exercise.find(".editable-chunks").each(function() {
				removeAssemblyItem($(this));
			});
			$("#nav-ex" + exercise.attr("id").substring(exercise.attr("id").indexOf(exercise.attr("id").match(/\d/)))).remove();
			exercise.remove();
			//TODO: update item titles
		}

		/**
		 Opens the sidebar.
		*/
		function showSidebar() {
			$("#sidebar").removeClass("invisible");
			$("#settings-button").addClass("invisible");
		}

		/**
		 Closes the sidebar.
		*/
		function hideSidebar() {
			$("#sidebar").addClass("invisible");
			$("#settings-button").removeClass("invisible");
		}

		/**
		 Displays the selection for exercise types to generate in the main view.
		*/
		function displayTypeSettings() {
			$(".exercise-spec").addClass("invisible");
			$("#exercise-assemblies").addClass("invisible");
			$("#type-settings").removeClass("invisible");			
		}

		/**
		 Moves the selected list items to the left container.
		*/
		function moveLeft(item) {
			$("#type-generate").append($("#type-pool").find('.list-group-item.active'));
		}

		/**
		 Moves the selected list items to the right container.
		*/
		function moveRight(item) {
			$("#type-pool").append($("#type-generate").find('.list-group-item.active'));
		}

		/**
		 Creates a deep copy of a string.
		*/
		function copyString(str) {
			return (' ' + str).slice(1);
		}

		/**
		 Adds an element to the tree item string.
		*/
		function addTreeElement(treeStr, key, val, id, margin, className) {
			if (val !== null) {
				treeStr += '<li class="list-group-item node-treeview1 invisible ' + className + '" style="border:0px;background:none;"><span class="form-check" style="margin-left: ' + margin + 'px;"><input type="checkbox" checked class="form-check-input" onclick="onTypeChecked(this)"><label class="form-check-label" data-toggle="collapse" data-target="#t' + id.toString() + '" aria-expanded="true" aria-controls="t' + id.toString() + '">' + key + '</label></span></li><div id="t' + id.toString() + '" class="collapse show">';
				id++;
				margin += 10;
				for (const [k, v] of Object.entries(val)) {
					let ret = addTreeElement(copyString(treeStr), k, v, id, margin, className);
					id = ret[0];
					treeStr = ret[1];
				}

				treeStr += "</div>";

			} else {
				treeStr += '<li class="list-group-item node-treeview1 invisible ' + className + '" style="border:0px;background:none;"><span class="form-check" style="margin-left: ' + margin + 'px;"><input type="checkbox" checked class="form-check-input" onclick="onTypeChecked(this)"><label class="form-check-label">' + key + '</label></span></li>';
			}

			return [id, treeStr];
		}

		/**
		Reacts to checking or unchecking tree items of the exercise types to generate.
		*/
		function onTypeChecked(item) {
			onTypeCheckedWrapper($(item));
		}
		
		function onTypeCheckedWrapper(item) {
			// remove styling for "some children checked"
			item.removeClass("bold-border");
			// check/ uncheck children
			if (item.closest(".list-group-item").next().hasClass("collapse")) {
				item.closest(".list-group-item").next().find(".form-check-input").prop('checked', item.is(':checked'));
			}

			setExerciseTypeCheckboxes();
		}

		function setExerciseTypeCheckboxes() {
			let has_changed = true;
			while (has_changed) {
				has_changed = false;
				for (const item of $(".collapse-tree").find("input")) {
					let parent = $(item).closest(".collapse").prev().find(".form-check-input");
					if (parent.length > 0) {
						let siblings = $(item).closest(".collapse").find(".form-check-input");
						let checked_siblings = $(item).closest(".collapse").find(".form-check-input:checked");


						let allChildrenChecked = siblings.length === checked_siblings.length;
						let itemChecked = parent.is(':checked');
						if (allChildrenChecked !== itemChecked) {
							has_changed = true;
						}
						parent.prop('checked', allChildrenChecked);

						// add/ remove styling for "some children checked"
						if (siblings.length > 0 && siblings.length !== checked_siblings.length && checked_siblings.length > 0) {
							parent.addClass("bold-border");
						} else {
							parent.removeClass("bold-border");
						}
					} else {}
				}
			}
		}

		/**
		Saves the specified exercises to a JSON file.
		*/
		function save() {
			var dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(getSpec()));
			var dlAnchorElem = document.getElementById('downloadAnchorElem');
			dlAnchorElem.setAttribute("href", dataStr);
			dlAnchorElem.setAttribute("download", "exercise_specification.json");
			dlAnchorElem.click();
		}

		function getSpec() {
			if ($("#btnTopic").text() === "Conditionals") {
				return getConditionalSpec();
			} else if ($("#btnTopic").text() === "Relative pronouns") {
				return getRelativeSpec();
			}
		}

		function getRelativeSpec() {
			var spec = {
				"topic": $("#btnTopic").text()
			};
			var exercises = [];
			spec["items"] = exercises;

			for (const exercise of $(".exercise-spec.rel")) {
				var ex = {
						"contextBefore": $(exercise).find(".contextBefore").val(),
						"contextAfter": $(exercise).find(".contextAfter").val(),
						"clause1": $(exercise).find(".c1 input").val(),
						"clause2": $(exercise).find(".c2 input").val(), 
						"feedback": $(exercise).find(".feedback").val()
						};
				exercises.push(ex);

				var distractors = [];
				
				for (const distr of $(exercise).find(".distractors .listItems li")) {
					distractors.push($(distr).find("span").last().text());
				}
				ex["distractors"] = distractors;

				var pronouns = [];
				for (const pron of $(exercise).find(".pronouns .listItems li")) {
					pronouns.push($(pron).find("span").last().text());
				}
				ex["pronouns"] = pronouns;

				let relativeClauses = [];
				$(exercise).find(".editable-chunks").each(function () {
					let clauseChunks = $(this).text().split("|");
					let chunks = [];
					let n = 1;
					let pronounIndex = 1;
					for (const chunk of clauseChunks) {
						if(chunk.trim().startsWith("<mark>")) {
							chunks.add(chunk.trim().replace("<mark>", "").replace("</mark>", ""));
						} else {
							chunks.add(chunk.trim());
							pronounIndex++;
						}
					}
					let pronounIsOptional = $(this).closest("tr").find(".pronOpt").prop("checked");
					let generateDistinctExercise = $(this).closest("tr").find(".genDist").prop("checked");
					
					let prompt = parseInt($(this).find(".spn2").val());
					relativeClauses.push({"id": $(this).closest(".rel-sentence-order").attr("id"), "chunks": chunks, 
						"pronounIsOptional": pronounIsOptional, "generateDistinctExercise": generateDistinctExercise,
						"pronounIndex": pronounIndex, "prompt": prompt});
				});

				ex["relativeClauses"] = relativeClauses;
			}

			spec["exerciseTypes"] = getSelectedExerciseTypes();
			spec["exerciseItemMap"] = getExerciseItemMap();

			return spec;
		}
		
		function getSelectedExerciseTypes() {
			let exercise_types = [];
			
			for (const ti of $("#types-tree").find("input:checked")) {
				if (!$(ti).parent().parent().hasClass("invisible")) {
					let attr = $(ti).attr("id");

					if (typeof attr !== 'undefined' && attr !== false) {
						// it's an inner element
						exercise_types.push($(ti).attr("id"));
					}
				}
			}
			
			return exercise_types;
		}
		
		function getExerciseItemMap() {
			let exerciseItemMap = [];
			$(".assembly").each(function() {
				let sentencesList = [];
				$(this).find(".sortable li").each(function() {
					sentencesList.push($(this).attr("id").substring(2));
				});
				exerciseItemMap.push({"Title": $(this).find("h3 input").val(), "sentences": sentencesList})
			});
			
			return exerciseItemMap;
		}


		/**
		Generates a JSON from the specified exercises.
		*/
		function getConditionalSpec() {
			var spec = {
				"topic": $("#btnTopic").text()
			};
			var exercises = [];
			spec["items"] = exercises;

			for (const exercise of $(".exercise-spec.cond")) {
				var ex = {
						"condType": $(exercise).find(".btn-cond-type").text(),
						"contextBefore": $(exercise).find(".contextBefore").val(),
						"contextAfter": $(exercise).find(".contextAfter").val(),
						"mainClause": getClauseValues("main-clause", $(exercise)),
						"ifClause": getClauseValues("if-clause", $(exercise)),
						"id": $(exercise).attr("id"),
						"feedback": $(exercise).find(".feedback").val()
						};
				exercises.push(ex);
			}

			spec["exerciseTypes"] = getSelectedExerciseTypes();
			spec["exerciseItemMap"] = getExerciseItemMap();

			return spec;
		}

		function getClauseValues(clauseStr, sentence) {
			var clauseSpec = {};
			clauseSpec["chunks"] = sentence.find("." + clauseStr + " .editable-chunks").text().split("|");
			clauseSpec["translation"] = sentence.find("." + clauseStr + " .translation input").val();
			var distractors = [];
			for (const distr of sentence.find(".distractors .listItems li")) {
				distractors.push($(distr).find("span").last().text());
			}
			clauseSpec["distractors"] = distractors;
			clauseSpec["givenWord"] = sentence.find("." + clauseStr + " .given-word input").val();
			clauseSpec["semanticDistractor"] = sentence.find("." + clauseStr + " .semantic-distractor input").val();
			var givenWordsExt = [];
			for (const gwe of sentence.find(".given-words-ext .listItems li")) {
				givenWordsExt.push($(gwe).find("span").last().text());
			}
			clauseSpec["givenWordsExtended"] = givenWordsExt;
			clauseSpec["gap"] = [parseInt(sentence.find("." + clauseStr + " .gap .spn1").val()), parseInt(sentence.find("." + clauseStr + " .gap .spn2").val())];
			clauseSpec["mtwTarget"] = [parseInt(sentence.find("." + clauseStr + " .mtw-target .spn1").val()), parseInt(sentence.find("." + clauseStr + " .mtw-target .spn2").val())];

			return clauseSpec;
		}

		/**
		Opens the file selection dialog.
		*/
		function load() {
			$("#btn-upload").click();
		}

		/**
		Loads a specification from a JSON file.
		*/
		function upload(item) {
			if (item.files.length <= 0) {
				return;
			}

			var fr = new FileReader();
			fr.onload = function (e) {
				var result = JSON.parse(e.target.result);
				populateFromJson(result);
			}

			fr.readAsText(item.files.item(0));
		}

		function uploadFromFLAIR(fileContent) {
			var fr = new FileReader();
			fr.onload = function (e) {
				var result = JSON.parse(e.target.result);
				populateFromJson(result);
			}

			fr.readAsText(fileContent);
		}
		
		function deleteAssembly(item) {
			$(item).closest(".assembly").remove();
		}

		/**
		Populates the UI with the exercises specified in the JSON file.
		*/
		function populateFromJson(json) {
			var is_valid = true;

			// remove all exercises
			for (const e of $(".exercise-spec")) {
				deleteExerciseItem($(e));
			}
			for (const e of $(".assembly")) {
				$(e).remove();
			}

			try {
				if ($("#topicdrp").find(".dropdown-item:contains('" + json["topic"] + "')").length > 0) {
					$("#btnTopic").text(json["topic"]);
				} else {
					is_valid = false;
				}

				if (is_valid) {
					for (const sent of json["items"]) {
						if (!is_valid) {
							break;
						}

						addExercise();
						let newExercises = $(".exercise-spec");
						let exercise = $(newExercises[newExercises.length - 1]);

						exercise.find(".contextBefore").val(sent["contextBefore"]);
						exercise.find(".contextAfter").val(sent["contextAfter"]);
						exercise.find(".feedback").val(sent["feedback"]);

						if ($("#btnTopic").text() === "Conditionals") {
							if (exercise.find(".condType .dropdown-item:contains('" + sent["condType"] + "')").length > 0) {
								exercise.find(".btn-cond-type").text(sent["condType"]);
							} else {
								is_valid = false;
								break;
							}

							fillClause(sent["mainClause"], "main-clause", exercise);
							fillClause(sent["ifClause"], "if-clause", exercise);
						} else if ($("#btnTopic").text() === "Relative pronouns") {
							exercise.find(".c1 input").val(sent["clause1"]);
							exercise.find(".c2 input").val(sent["clause2"]);
							exercise.find(".feedback").val(sent["feedback"]);

							for (const pronoun of sent["pronouns"]) {
								exercise.find(".pronouns .modal input").val(pronoun);
								addDistractor(exercise.find(".pronouns .modal button"));
							}

							for (const distractor of sent["distractors"]) {
								exercise.find(".distractors .modal input").val(distractor);
								addDistractor(exercise.find(".distractors .modal button"));
							}

							for (const relSent of sent["relativeClauses"]) {
								addRelativeOrder($(".orders").last());
														
								let chunkTexts = [];
								let n = 1;
								let chunkTextbox = $(".rel-sentence-order").last().find(".editable-chunks");
								for (const chunk of relSent["chunks"]) {
									if(n === relSent["pronounIndex"]) {
										chunkTextbox.parent().prev().append("<span style='border:1px solid grey; margin-right: 2px;'><mark>" + chunk.trim() + "</mark></span>");
										chunkTexts.push("<mark>" + chunk + "</mark>");
									} else {
										chunkTextbox.parent().prev().append("<span style='border:1px solid grey; margin-right: 2px;'>" + chunk.trim() + "</span>");
										chunkTexts.push(chunk);
									}
									n++;									
								}
								
								chunkTextbox.html(chunkTexts.join("|"));
								if(relSent["pronounIsOptional"]) {
									$(".rel-sentence-order input").last().prop("checked", true);
								}
								
								$(".rel-sentence-order").last().find(".spn2").val(relSent["prompt"]);
								setInputValues(chunkTextbox.closest(".chunks-container").find('.idx'));
							}
						}
					}

					// uncheck all tree items 
					for (const ti of $("#types-tree").find("input")) {
						$(ti).prop("checked", false);
					}

					for (const ti of json["exerciseTypes"]) {
						$("#" + ti).prop("checked", true);
					}				
					
					for (const item of json["exerciseItemMap"]) {
						addExerciseAssembly();
						$("#assembly-container").children().last().find("h3 input").val(item["Title"]);
						for (const sentence of item["sentences"]) {
							let i = 0;
							let itemId;
							loop1: for (const sent of json["items"]) {
								for(const relCl of sent["relativeClauses"]) {
									if(relCl["id"] == sentence) {
										let newExercises = $(".rel-sentence-order");
										let exercise = $(newExercises[i]);
										itemId = exercise.attr("id");
										break loop1;
									}
									i++;
								}
							}
							let itemToCheck = $("#assembly-container").children().last().find("#l" + maxAssemblyId + itemId);
							itemToCheck.prop("checked", true);
							onExerciseItemChecked(itemToCheck);
						}
					}
					
					setExerciseTypeCheckboxes();
					
					onSelectedTopicChanged();
					displayExercise("#" + $(".exercise-spec").first().attr("id"));
				}
			} catch (e) {
				console.log(e);
				is_valid = false;
			}

			if (!is_valid) {
				// remove all exercises
				for (const e of $(".exercise-spec")) {
					deleteExerciseItem($(e));
				}
				for (const e of $(".assembly")) {
					$(e).remove();
				}
				
				alert("The exercise file is invalid.");
			}
		}

		function fillClause(clause, clauseStr, sentence) {
			sentence.find("." + clauseStr + " .editable-chunks").text(clause["chunks"].join('|'));
			updateChunks(sentence.find("." + clauseStr + " .editable-chunks"));
			sentence.find("." + clauseStr + " .translation input").val(clause["translation"]);
			for (const distractor of clause["distractors"]) {
				sentence.find("." + clauseStr + " .distractors .modal input").val(distractor);
				addDistractor(sentence.find("." + clauseStr + " .distractors .modal button"));
			}
			sentence.find("." + clauseStr + " .given-word input").val(clause["givenWord"]);
			sentence.find("." + clauseStr + " .semantic-distractor input").val(clause["semanticDistractor"]);
			for (const givenWordExt of clause["givenWordsExtended"]) {
				sentence.find("." + clauseStr + " .given-words-ext .modal input").val(givenWordExt);
				addDistractor(sentence.find("." + clauseStr + " .given-words-ext .modal button"));
			}
			sentence.find("." + clauseStr + " .gap .spn1").val(clause["gap"][0]);
			sentence.find("." + clauseStr + " .gap .spn2").val(clause["gap"][1]);
			changeSpinnerText(sentence.find("." + clauseStr + " .gap .spn1"));
			sentence.find("." + clauseStr + " .mtw-target .spn1").val(clause["mtwTarget"][0]);
			sentence.find("." + clauseStr + " .mtw-target .spn2").val(clause["mtwTarget"][1]);
			changeSpinnerText(sentence.find("." + clauseStr + " .mtw-target .spn1"));
		}

		var targetClauses = {
			"Target only if-clause": null,
			"Target only main clause": null,
			"Target random clause": null,
			"Target both clauses": null
		};
		var exerciseTypes = ["Single Choice (2 options)", "Single Choice (4 options)", "Fill-in-the-Blanks (lemma in parentheses)",
			"Fill-in-the-Blanks (lemma + distractor in parentheses)", "Fill-in-the-Blanks (lemmas in instructions)"
		];
		var clauseOrder = ["If-clause + main clause", "Main clause + if-clause", "Random clause order"];

		var exerciseTypeDict = {};
		for (const el of exerciseTypes) {
			exerciseTypeDict[el] = targetClauses;
		}
		exerciseTypeDict["Categorize"] = null;

		var clauseOrderDict = {};
		for (const el of clauseOrder) {
			clauseOrderDict[el] = exerciseTypeDict;
		}

		var typeExerciseTypesAllClauses = ["Single Choice (2 options)", "Single Choice (4 options)", 
			"Fill-in-the-Blanks (lemma in parentheses)",
			"Fill-in-the-Blanks (lemma + distractor in parentheses)", "Half-open", 
			"Fill-in-the-Blanks (lemmas in instructions)", "Memory", "Jumbled Sentences"
		];
		var typeExerciseTypesWithoutBothClauses = ["Mark the Words"];

		var typeExerciseTypeDict = {};
		for (const el of typeExerciseTypesAllClauses) {
			typeExerciseTypeDict[el] = targetClauses;
		}
		for (const el of typeExerciseTypesWithoutBothClauses) {
			typeExerciseTypeDict[el] = {
				"Target only if-clause": null,
				"Target only main clause": null
			};
		}

		var typeClauseOrderDict = {};
		for (const el of clauseOrder) {
			typeClauseOrderDict[el] = typeExerciseTypeDict;
		}

		var relExerciseTypes = {"Memory": null, "Mark the Words": null, "Single Choice": null, "Fill-in-the-Blanks": null, "Half-open": null, "Open": null};
		var relClauseOrder = ["Clause 1 + clause 2", "Clause 2 + clause 1", "Random clause order"];
		var relClauseOrderDict = {};
		for (const el of relClauseOrder) {
			relClauseOrderDict[el] = relExerciseTypes;
		}
		var relContactExerciseTypes = {"Half-open": null, "Open": null, "Categorize": null};
		var relContactClauseOrderDict = {};
		for (const el of relClauseOrder) {
			relContactClauseOrderDict[el] = relContactExerciseTypes;
		}
		
		var topLevelExercises = {
			"cond": {
				"Type 1 vs Type 2": clauseOrderDict,
				"Formation": typeClauseOrderDict
			},
			"rel": {
				"Relative pronoun": relClauseOrderDict,
				"Contact clauses": relContactClauseOrderDict
			}
		};

		let treeStr = "";
		let id = 1;
		for (const [k, v] of Object.entries(topLevelExercises)) {
			for (const [key, value] of Object.entries(v)) {
				let ret = addTreeElement(treeStr, key, value, id, 10, k);
				id = ret[0];
				treeStr = ret[1];
			}
		}

		$("#types-tree").append(treeStr);

		for (const ti of $("#types-tree").find("input")) {
			let attr = $(ti).next().attr("data-toggle");

			if (typeof attr === 'undefined' || attr === false) {
				// it's an inner element
				let id = $(ti).next().text();
				let parent = $(ti).closest("div.collapse").prev();
				while (parent && parent.prop("tagName") === "LI") {
					id = $(parent).text() + "_" + id;
					parent = parent.closest("div.collapse").prev();
				}
				$(ti).attr("id", id.replaceAll(" ", "").replaceAll("+", "").replaceAll("(", "").replaceAll(")", ""));

			}
		}

	</script>
</body>

</html>